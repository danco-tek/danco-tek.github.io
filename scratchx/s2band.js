// Johnny Chuang, January 2018
// SmartBand Scratch Extension
(function(e){function t(){if(f=D.shift()){f.open({stopBits:0,bitRate:115200,ctsFlowControl:0});console.log("connection with "+f.id);f.set_receive_handler(M);var a=new Uint8Array([36,120,10,10,10,10]);f.send(a.buffer);u=setInterval(function(){f.send(a.buffer)},500);n=setTimeout(function(){v();f&&f.close();t()},2E3)}}function x(){n&&(clearTimeout(n),n=null)}function v(){u&&(clearInterval(u),u=null)}function M(a){a=new Uint8Array(a);36==a[0]&&68==a[1]&&(x(),v(),f.set_receive_handler(N),c.getMac(f),console.log("found "+
f.id))}function N(a){a=new Uint8Array(a);c.parse(a)}function O(a){0==c.mac.length&&f&&c.getMac(f)}function P(a){p.updateS(a)}function Q(a){q.updateS(Math.abs(a))}function w(a,b,d,c){b=new Uint8Array([36,100,48,b+48,d+48,10,10,10,10]);y(a,b.buffer,c)}function l(a,b,d){b=new Uint8Array([36,101,48,b+48,10,10,10,10]);y(a,b.buffer,d)}function y(a,b,d){0==d?a.send(b):setTimeout(function(){a.send(b)},d)}function E(a,b){num=z(b-a,360);180<num&&(num-=360);return num}function z(a,b){return Math.max(0,Math.min(b,
a-Math.floor(a/b)*b))}function k(a,b){var d=(b&255)<<8|a&255;32767<d&&(d-=65536);return d}function F(a){a-=256;-128>a&&(a=-128);return a}function G(a){a+=128;return 0==a?0:10>a?1:85<a?10:a=Math.round(a/9)}var c=null,p=null,q=null,H=null,I=null,J=null,f=null,u=null,n=null,D=[];e._deviceConnected=function(a){D.push(a);console.log("deviceConnected:"+a.id);f||t()};e._deviceRemoved=function(a){console.log("deviceRemoved:"+a.id);f==a&&(v(),x(),f&&f.close(),t())};e._shutdown=function(){console.log("shutdown:"+
f.id);f&&f.close();v();x();f&&f.close();t()};e._getStatus=function(){return f?n?{status:1,msg:"Probing for SmartBand"}:{status:2,msg:"SmartBand connected"}:{status:1,msg:"SmartBand disconnected"}};e.d33=function(a){return enumConnect[a]?c.dataConnected:!c.dataConnected};e.d24=function(){return c.dataConnected};e.d25=function(){return c.battery};e.d26=function(){return c.rssi10};e.d27=function(){return c.mac};e.d30=function(){return c.d30()};e.d08=function(){return c.d30()};e.d06=function(){return c.d06(0)};
e.d03=function(){return c.getMouse(0)};e.d04=function(){return c.getMouse(1)};e.getHandZ=function(){return c.getHandZ()};e.d00=function(){return H.smooth(240*c.getMouse(0))};e.d01=function(a,b){return I.smooth(180*c.getMouse(1))};e.d02=function(a){return R[a]?J.smoothAngle(c.getHandZ()):c.getHandZ()};e.d32=function(a,b,d){return p.isPowerGreater(a,b,d)};e.d31=function(a,b,d){return q.isPowerGreater(a,b,d)};e.d18=function(){return p.getForce()};e.d19=function(a){p.pauseUpdateS(a)};e.d14=function(){return q.getForce()};
e.d15=function(a){q.pauseUpdateS(a)};e.d21=function(a){c.checkLR=!0;var b=c.wayCheckLR.getWay();return 4==A[a]?1==b:-1==b};e.d20=function(a){c.checkTD=!0;var b=c.wayCheckTD.getWay();return 1==A[a]?1==b:-1==b};e.d16=function(a){c.checkRZ=!0;var b=c.wayCheckRZ.getWay();return 4==A[a]?1==b:-1==b};e.d09=function(a,b,d){a=parseInt(a);b=B[b];c.vibrate(f,a,b);setTimeout(function(){d()},100*b+200)};e.d10=function(a,b,d){a=K[a];b=parseInt(b);c.ledOn(f,a,b);setTimeout(function(){d()},500)};e.d12=function(a,
b,d,e){c.ledOnPro(f,parseInt(a),parseInt(b),parseInt(d));setTimeout(function(){e()},500)};e.d11=function(a,b,d,e,g){a=K[a];b=parseInt(b);c.ledFlash(f,a,B[d],B[e],b);setTimeout(function(){g()},500)};var R={"\u6253\u958b":!0,"\u95dc\u6389":!1},A={"\u4e0a":1,"\u4e0b":2,"\u5de6":3,"\u53f3":4},K={"\u7d05":0,"\u7da0":1,"\u85cd":2},B={"0.1":1,"0.2":2,"0.3":3,"0.4":4,"0.5":5,"0.6":6,"0.7":7,"0.8":8,"0.9":9},S={blocks:[["r","\u7a7a\u4e2d\u6ed1\u9f20\u7684 X\u5ea7\u6a19 (\u5e73\u6ed1)","d00"],["r","\u7a7a\u4e2d\u6ed1\u9f20\u7684 Y\u5ea7\u6a19 (\u5e73\u6ed1)",
"d01"],["r","\u7a7a\u4e2d\u6ed1\u9f20\u7684 X\u6bd4\u4f8b (-1~1)","d03"],["r","\u7a7a\u4e2d\u6ed1\u9f20\u7684 Y\u6bd4\u4f8b (-1~1)","d04"],[" ","\u5c07\u7a7a\u4e2d\u6ed1\u9f20\u7684 X\u5ea7\u6a19 \u8a2d\u5b9a\u70ba0","d06"],["-"],["r","\u624b\u8155\u65cb\u8f49\u89d2\u5ea6 (-180~180, %m.onOff \u5e73\u6ed1)","d02","\u6253\u958b"],["-"],["h","\u7576\u6309\u4e0b\u624b\u74b0\u6309\u9215","d30"],["b","\u6309\u4e0b\u4e86\u624b\u74b0\u6309\u9215","d08"],["w","\u8b93\u624b\u74b0\u9707\u52d5 , \u5f37\u5ea6: %d.powerV , \u79d2\u6578: %d.second \u79d2",
"d09",5,.5],["w","\u8b93\u624b\u74b0\u4eae %m.color3 \u71c8 , \u4eae\u5ea6: %d.light9","d10","\u85cd",5],["w","\u8b93\u624b\u74b0\u9583 %m.color3 \u71c8 , \u4eae\u5ea6: %d.light9 , \u4eae %d.second \u79d2 , \u7184 %d.second \u79d2","d11","\u7da0",5,.3,.3],["w","\u540c\u6642\u4eae\u71c8 , \u7d05\u71c8\u4eae\u5ea6: %d.light10 , \u7da0\u71c8\u4eae\u5ea6: %d.light10 , \u85cd\u71c8\u4eae\u5ea6: %d.light10","d12",0,0,5],["-"],["h","\u7576\u624b\u8155\u65cb\u8f49\u7684\u901f\u5ea6\u5927\u65bc %n , \u52a0\u901f\u5927\u65bc %n , \u66ab\u505c\u5075\u6e2c %n \u79d2",
"d31",30,5,.3],["r","\u624b\u8155\u65cb\u8f49\u7684\u901f\u5ea6","d14"],[" ","\u66ab\u505c\u5075\u6e2c \u624b\u8155\u65cb\u8f49 %d \u79d2","d15",.5],["b","\u624b\u8155\u5411 %m.wayLR \u65cb\u8f49","d16","\u53f3"],["-"],["h","\u7576\u63ee\u624b\u7684\u901f\u5ea6\u5927\u65bc %n , \u52a0\u901f\u5927\u65bc %n , \u66ab\u505c\u5075\u6e2c %n \u79d2","d32",1,.3,.3],["r","\u63ee\u624b\u7684\u901f\u5ea6","d18"],[" ","\u66ab\u505c\u5075\u6e2c \u63ee\u624b %n \u79d2","d19",.3],["b","\u624b\u662f\u5411 %m.wayTD \u63ee (\u4e0a\u4e0b)",
"d20","\u4e0a"],["b","\u624b\u662f\u5411 %m.wayLR \u63ee (\u5de6\u53f3)","d21","\u5de6"],["-"],["h","\u7576\u624b\u74b0\u9023\u7dda %m.connect","d33","\u4e2d\u65b7"],["b","\u624b\u74b0\u9023\u63a5\u4e0a\u96fb\u8166\u4e86","d24"],["r","\u624b\u74b0\u96fb\u91cf (0~100)","d25"],["r","\u8a0a\u865f\u5f37\u5ea6 (0~10)","d26"],["r","\u624b\u74b0\u865f\u78bc","d27"]],menus:{onOff:["\u6253\u958b","\u95dc\u6389"],wayTD:["\u4e0a","\u4e0b"],wayLR:["\u5de6","\u53f3"],color3:["\u7d05","\u7da0","\u85cd"],powerV:"456789".split(""),
second:"0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9".split(" "),light9:"123456789".split(""),light10:"0123456789".split(""),angle:["0","90","180","270"]},url:"http://danco-tek.com/scratch/"};(function(){$.getScript("http://danco-tek.github.io/scratchx/lib/gl-matrix-min.js").done(function(a,b){console.log("Loading completed");c||(p=new h,q=new h,H=new m,I=new m,J=new m,c=new g,c.onDataL=P,c.onDataZ=Q,c.onDataU=O);ScratchExtensions.register("danco-band",S,e,{type:"serial"})}).fail(function(a,b,d){console.log("Error loading lib");
console.log(d)})})();var T=2/Math.PI,C=[0,1,0],U=Math.PI,L=2*Math.PI,g=function(){this.q=[0,0,0,0];this.a=[0,0,0];this.air=[0,0];this.onDataU=this.onDataZ=this.onDataL=null;this.pressed=!1;this.battery=0;this.rssi=-128;this.rssi10=0;this.mac="";this.dataConnected=!1;this.quaternion=quat.create();this.doQuat=!1;this.ray=vec3.create();this.doRay=!1;this.rayCache=vec3.create();this.handZ=this.angleY=0;this.doHandZ=!1;this.deltaY=0;C=vec3.fromValues(0,1,0);this.deltaZ=this.zCache=this.pressdTime=0;this.checkRZ=
this.checkFB=this.checkLR=this.checkTD=this.doMouse=this.doDeltaZ=!1;this.wayCheckTD=new r;this.wayCheckLR=new r;this.wayCheckRZ=new r;this.wayZ=0};g.prototype.parse=function(a){this.dataConnected=!0;var b=a[2];if(1==b)25>a.length||(this.q[0]=k(a[4],a[5]),this.q[1]=k(a[7],a[8]),this.q[2]=k(a[10],a[11]),this.q[3]=k(a[13],a[14]),this.a[0]=.001*k(a[16],a[17]),this.a[1]=.001*k(a[19],a[20]),this.a[2]=.001*k(a[22],a[23]),this.doMouse=this.doDeltaZ=this.doHandZ=this.doRay=this.doQuat=!1,this.checkRZ&&(this.getDeltaZ(),
this.wayCheckRZ.update(this.deltaZ)),this.checkTD&&(a=180*this.ray[2],this.updateQuat(),this.updateRay(),this.wayCheckTD.update(E(a,180*this.ray[2]))),this.checkLR&&(this.getMouse(0),this.wayCheckLR.update(180*this.deltaY)),this.checkFB&&(a=this.a[1],this.wayZ=.1<a?1:-.1>a?-1:0),this.onDataL&&(a=vec3.length(this.a),this.onDataL(a)),this.onDataZ&&(this.getDeltaZ(),this.onDataZ(this.deltaZ)));else{if(2==b)this.pressed=!0,this.pressdTime=Date.now();else if(3==b)7<=a.length&&(this.battery=a[4],this.rssi=
F(a[5]),this.rssi10=G(this.rssi));else if(4==b)this.dataConnected=!1,this.rssi=-128,this.rssi10=0;else if(5==b&&37<=a.length){this.battery=a[5];this.rssi=F(a[6]);this.rssi10=G(this.rssi);for(var d="",c=9;15>c;c++)d+=a[c].toString(16);this.mac=d.toUpperCase()}if(this.onDataU)this.onDataU(b)}};g.prototype.d30=function(){var a=this.pressed;this.pressed=!1;return 300<Date.now()-this.pressdTime?!1:a};g.prototype.vibrate=function(a,b,d){b=new Uint8Array([36,97,48,b+48,d+48,10,10,10,10]);a.send(b.buffer)};
g.prototype.ledOn=function(a,b,d){this.ledOffAll(a,b);w(a,b,d,300)};g.prototype.ledOffAll=function(a,b){var d=0;0!=b&&(l(a,0,0),d+=150);1!=b&&(l(a,1,d),d+=150);2!=b&&l(a,2,d)};g.prototype.ledFlash=function(a,b,d,c,e){this.ledOffAll(a,b);b=new Uint8Array([36,102,48,b+48,d+48,c+48,e+48,10,10,10,10]);y(a,b.buffer,300)};g.prototype.ledOnPro=function(a,b,d,c){0==b?l(a,0,0):w(a,0,b,0);0==d?l(a,1,150):w(a,1,d,150);0==c?l(a,2,300):w(a,2,c,300)};g.prototype.getMac=function(a){var b=new Uint8Array([36,119,
10,10,10,10]);a.send(b.buffer)};g.prototype.getHandZ=function(){this.updateHandZ();return this.handZ};g.prototype.updateHandZ=function(){if(!this.doHandZ){var a=this.q[0],b=this.q[1],d=this.q[2],c=this.q[3];mag=Math.sqrt(a*a+b*b+d*d+c*c);mag=1E-6<=mag?1/mag:1E6;qW2=a*mag;qX2=b*mag;qY2=d*mag;qZ2=c*mag;ez=-57.29578*Math.atan2(2*(qX2*qZ2-qW2*qY2),1-2*(qX2*qX2+qY2*qY2));ez+=5;180<ez&&(ez-=360);this.handZ=ez;this.doHandZ=!0}};g.prototype.getDeltaZ=function(){if(this.doDeltaZ)return this.deltaZ;this.updateHandZ();
this.deltaZ=E(this.zCache,this.handZ);this.zCache=this.handZ;this.doDeltaZ=!0;return this.deltaZ};g.prototype.getMouse=function(a){if(this.doMouse)return this.air[a];this.updateQuat();this.updateRay();this.air[1]=Math.tan(Math.atan2(this.ray[2],1));this.air[1]=Math.max(-1,Math.min(1,2.4*this.air[1]));vec3.set(this.rayCache,this.ray[0],Math.tan(Math.atan2(this.ray[1],1)),0);var b=vec3.angle(C,this.rayCache);0>this.ray[0]&&(b*=-1);num=z(b-this.angleY,L);num>U&&(num-=L);this.deltaY=num*T;this.angleY=
b;this.air[0]=Math.max(-1,Math.min(1,this.air[0]+2.4*this.deltaY));this.doMouse=!0;return this.air[a]};g.prototype.d06=function(a){this.air[0]=Math.max(-1,Math.min(1,a))};g.prototype.updateQuat=function(){this.doQuat||(quat.set(this.quaternion,this.q[1],this.q[2],this.q[3],this.q[0]),quat.normalize(this.quaternion,this.quaternion),this.doQuat=!0)};g.prototype.updateRay=function(){this.doRay||(vec3.transformQuat(this.ray,C,this.quaternion),this.doRay=!0)};var h=function(){this.triggerForce=1;this.lockTime=
.3;this.magnitude=this.accPower=this.instantForce=0;this.triggerFlag=!1;this.lastForce=0;this.onTrigger=null;this.pauseUpdate=this.run=!1;this.pauseTimer=null;this.powerCount=0};h.prototype.pauseUpdateData=function(a){this.pauseTimer&&(clearTimeout(this.pauseTimer),this.pauseTimer=null);this.pauseUpdate=!0;var b=this;this.pauseTimer=setTimeout(function(){b.pauseUpdateDataEnd()},a)};h.prototype.pauseUpdateDataEnd=function(){this.magnitude=this.accPower=0;this.triggerFlag=!1;this.powerCount=this.lastForce=
0;this.pauseUpdate=!1};h.prototype.updateS=function(a){this.run&&!this.pauseUpdate&&(this.lastForce=this.magnitude,this.magnitude=a,this.magnitude>this.accPower?(this.accPower=this.magnitude,this.powerCount=0):(this.powerCount++,3<this.powerCount&&(this.powerCount=this.accPower=0)))};h.prototype.isPowerGreater=function(a,b,c){this.run=!0;if(this.accPower>=a){if(0<this.deltaForce&&Math.abs(this.magnitude-this.lastForce)<this.deltaForce)return!1;this.pauseUpdateData(parseInt(1E3*c));this.accPower=0;
return!0}return!1};h.prototype.pauseUpdateS=function(a){this.pauseUpdateData(1E3*a);this.accPower=0};h.prototype.getForce=function(){this.run=!0;return this.accPower};var r=function(){this.way=this.v0=0;this.min=.1;this.max=.4;this.mpl=.5;this.res=0};r.prototype.update=function(a){var b=a-this.v0;this.v0=a;a=0;b>this.min?a=1:b<-this.min&&(a=-1);this.way+=a*this.mpl;1<this.way?this.way=1:-1>this.way&&(this.way=-1);this.res=this.way>this.max?1:this.way<-this.max?-1:0};r.prototype.getWay=function(){return this.res};
var m=function(){this.res=this.cache=0};m.prototype.lerp=function(a,b){if(0==b)return a;this.res=a+(this.cache-a)*(0>b?0:1<b?1:b);this.cache=a;return this.res};m.prototype.smooth=function(a){this.res=a+.5*(this.cache-a);this.cache=a;return this.res};m.prototype.smoothAngle=function(a){var b=z(this.cache-a,360);180<b&&(b-=360);this.res=a+.5*b;this.cache=a;return this.res}})({});