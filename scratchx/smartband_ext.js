(function(ext){var rxData=null;var gesture=[null,null];var smoother=[null,null,null];function loadJS(){$.when($.getScript("http://danco-tek.github.io/scratchx/lib/gl-matrix-min.js"),$.getScript("http://danco-tek.github.io/scratchx/lib/dc01u.js"),$.Deferred(function(deferred){$(deferred.resolve)})).done(function(){console.log("Loading completed");init()})}function init(){if(!rxData){gesture=[new ShakeGesture,new ShakeGesture];smoother=[new Smoother,new Smoother,new Smoother];rxData=new PData;rxData.onDataL=
onDataL;rxData.onDataZ=onDataZ}ScratchExtensions.register("danco-tek SmartBand",descriptor,ext,{type:"serial"})}var device=null;var poller=null;var watchdog=null;function tryNextDevice(){device=potentialDevices.shift();if(!device)return;device.open({stopBits:0,bitRate:115200,ctsFlowControl:0});console.log("connection with "+device.id);device.set_receive_handler(fnFindDevice);var pingCmd=new Uint8Array([36,120,10,10,10,10]);device.send(pingCmd.buffer);poller=setInterval(function(){device.send(pingCmd.buffer)},
500);watchdog=setTimeout(function(){clearPoller();disposeDevice(device);tryNextDevice()},2E3)}function clearWatchdog(){if(watchdog){clearTimeout(watchdog);watchdog=null}}function clearPoller(){if(poller){clearInterval(poller);poller=null}}function disposeDevice(dev){if(dev){dev.close();dev=null}}function fnFindDevice(data){var rx=new Uint8Array(data);if(rx[0]==36&&rx[1]==68){clearWatchdog();clearPoller();device.set_receive_handler(fnRX);rxData.getMac(device);console.log("found "+device.id)}}function fnRX(data){var rx=
new Uint8Array(data);rxData.parse(rx)}function onDataL(slen){gesture[0].updateS(slen)}function onDataZ(dz){gesture[1].updateS(Math.abs(dz))}var potentialDevices=[];ext._deviceConnected=function(dev){potentialDevices.push(dev);console.log("deviceConnected:"+dev.id);if(!device)tryNextDevice()};ext._deviceRemoved=function(dev){console.log("deviceRemoved:"+dev.id);if(device!=dev)return;clearPoller();clearWatchdog();disposeDevice(device);tryNextDevice()};ext._shutdown=function(){console.log("shutdown:"+
device.id);if(device)device.close();clearPoller();clearWatchdog();disposeDevice(device);tryNextDevice()};ext._getStatus=function(){if(!device)return{status:1,msg:"SmartBand disconnected"};if(watchdog)return{status:1,msg:"Probing for SmartBand"};return{status:2,msg:"SmartBand connected"}};ext.isBandConnect=function(val){if(enumConnect[val])return rxData.dataConnected;else return!rxData.dataConnected};ext.isBandConn=function(){return rxData.dataConnected};ext.getBattery=function(){return rxData.battery};
ext.getRssi=function(){return rxData.rssi10};ext.getBandName=function(){return rxData.mac};ext.isPressed=function(){return rxData.isPressed()};ext.isPressed2=function(){return rxData.isPressed()};ext.getMouseX=function(){return rxData.getMouse(0)};ext.getMouseY=function(){return rxData.getMouse(1)};ext.getHandZ=function(){return rxData.getHandZ()};ext.getMouseXMS=function(val,smooth){if(enumOnOff[smooth])return smoother[0].smooth(rxData.getMouse(0)*val);return rxData.getMouse(0)*val};ext.getMouseYMS=
function(val,smooth){if(enumOnOff[smooth])return smoother[1].smooth(rxData.getMouse(1)*val);return rxData.getMouse(1)*val};ext.getHandZAS=function(val,smooth){val=parseInt(val);if(enumOnOff[smooth])return smoother[2].smoothAngle(rxData.getHandZ()+val);return rxData.getHandZ()+val};ext.getForceAndPause=function(pow,delta,pauseSec){var res=gesture[0].isPowerGreater(pow,delta,pauseSec);return res};ext.getRotateAndPause=function(pow,delta,pauseSec){var res=gesture[1].isPowerGreater(pow,delta,pauseSec);
return res};ext.getG0=function(){return gesture[0].getForce()};ext.pauseG0=function(pauseSec){gesture[0].pauseUpdateS(pauseSec)};ext.getG1=function(){return gesture[1].getForce()};ext.pauseG1=function(pauseSec){gesture[1].pauseUpdateS(pauseSec)};ext.getShakeDirFB=function(fb){rxData.checkFB=true;var way=rxData.wayZ;if(enumDirection[fb]==5)return way==1;else return way==-1};ext.getShakeDirLR=function(lr){rxData.checkLR=true;var way=rxData.wayCheckLR.getWay();if(enumDirection[lr]==4)return way==1;else return way==
-1};ext.getShakeDirTD=function(td){rxData.checkTD=true;var way=rxData.wayCheckTD.getWay();if(enumDirection[td]==1)return way==1;else return way==-1};ext.getRotateLR=function(lr){rxData.checkRZ=true;var way=rxData.wayCheckRZ.getWay();if(enumDirection[lr]==4)return way==1;else return way==-1};ext.doVibrate=function(power,second,callback){var pow=parseInt(power);var mson=enumSecond[second];rxData.vibrate(device,pow,mson);var lockTime=mson*100+200;setTimeout(function(){callback()},lockTime)};ext.doLedOn=
function(color,power,callback){var col=enumLedColor[color];var pow=parseInt(power);rxData.ledOn(device,col,pow);var lockTime=500;setTimeout(function(){callback()},lockTime)};ext.doLedOnPro=function(r,g,b,callback){rxData.ledOnPro(device,parseInt(r),parseInt(g),parseInt(b));var lockTime=500;setTimeout(function(){callback()},lockTime)};ext.doLedFlash=function(color,power,on,off,callback){var col=enumLedColor[color];var pow=parseInt(power);var mson=enumSecond[on];var msoff=enumSecond[off];rxData.ledFlash(device,
col,mson,msoff,pow);var lockTime=500;setTimeout(function(){callback()},lockTime)};var enumConnect={"\u6210\u529f":true,"\u4e2d\u65b7":false};var enumOnOff={"\u958b":true,"\u95dc":false};var enumDirection={"\u4e0a":1,"\u4e0b":2,"\u5de6":3,"\u53f3":4,"\u524d":5,"\u5f8c":6};var enumLedColor={"\u7d05":0,"\u7da0":1,"\u85cd":2};var enumSecond={"0.1":1,"0.2":2,"0.3":3,"0.4":4,"0.5":5,"0.6":6,"0.7":7,"0.8":8,"0.9":9};var descriptor={blocks:[["r","\u7a7a\u4e2d\u6ed1\u9f20 X * %n , \u5e73\u6ed1 %m.onOff","getMouseXMS",
400,"\u958b"],["r","\u7a7a\u4e2d\u6ed1\u9f20 Y * %n , \u5e73\u6ed1 %m.onOff","getMouseYMS",300,"\u958b"],["r","\u624b\u8155\u65cb\u8f49\u89d2\u5ea6 + %d.angle , \u5e73\u6ed1 %m.onOff","getHandZAS",0,"\u958b"],["r","\u7a7a\u4e2d\u6ed1\u9f20 X (-1~1)","getMouseX"],["r","\u7a7a\u4e2d\u6ed1\u9f20 Y (-1~1)","getMouseY"],["r","\u624b\u8155\u65cb\u8f49\u89d2\u5ea6 (-180~180)","getHandZ"],["-"],["h","\u7576\u6309\u4e0b\u624b\u74b0\u6309\u9215","isPressed"],["b","\u6309\u4e0b\u4e86\u624b\u74b0\u6309\u9215",
"isPressed2"],["-"],["w","\u8b93\u624b\u74b0\u9707\u52d5 \u5f37\u5ea6: %d.powerV \u79d2\u6578: %d.second","doVibrate",5,.5],["w","\u8b93\u624b\u74b0\u4eae %m.color3 \u71c8 \u4eae\u5ea6: %d.light9","doLedOn","\u85cd",5],["w","\u8b93\u624b\u74b0\u9583 %m.color3 \u71c8 \u4eae\u5ea6: %d.light9 \u4eae %d.second \u79d2, \u6697 %d.second \u79d2","doLedFlash","\u7da0",5,.3,.3],["w","\u540c\u6642\u4eae\u71c8 \u7d05\u71c8\u4eae\u5ea6: %d.light10 , \u7da0\u71c8\u4eae\u5ea6: %d.light10 , \u85cd\u71c8\u4eae\u5ea6: %d.light10",
"doLedOnPro",0,0,5],["-"],["h","\u7576\u624b\u8155\u65cb\u8f49\u7684 \u901f\u5ea6\u5927\u65bc %n , \u52a0\u901f\u5927\u65bc %n , \u66ab\u505c\u5075\u6e2c %n \u79d2","getRotateAndPause",30,15,.5],["r","\u624b\u8155\u65cb\u8f49\u7684\u901f\u5ea6","getG1"],[" ","\u66ab\u505c\u5075\u6e2c \u624b\u8155\u65cb\u8f49 %d \u79d2","pauseG1",.5],["b","\u624b\u8155\u5411 %m.wayLR \u65cb\u8f49","getRotateLR","\u53f3"],["-"],["h","\u7576\u63ee\u624b\u7684 \u901f\u5ea6\u5927\u65bc %n , \u52a0\u901f\u5927\u65bc %n , \u66ab\u505c\u5075\u6e2c %n \u79d2",
"getForceAndPause",1,.3,.3],["r","\u63ee\u624b\u7684\u901f\u5ea6","getG0"],[" ","\u66ab\u505c\u5075\u6e2c \u63ee\u624b %n \u79d2","pauseG0",.5],["b","\u624b\u5411 %m.wayTD \u63ee (\u4e0a\u4e0b)","getShakeDirTD","\u4e0a"],["b","\u624b\u5411 %m.wayLR \u63ee (\u5de6\u53f3)","getShakeDirLR","\u5de6"],["b","\u624b\u5411 %m.wayFB \u63ee (\u524d\u5f8c)","getShakeDirFB","\u524d"],["-"],["h","\u7576\u624b\u74b0\u9023\u7dda %m.connect","isBandConnect","\u4e2d\u65b7"],["b","\u624b\u74b0\u9023\u63a5\u4e0a\u96fb\u8166",
"isBandConn"],["-"],["r","\u624b\u74b0\u96fb\u91cf (0~100)","getBattery"],["r","\u8a0a\u865f\u5f37\u5ea6 (0~10)","getRssi"],["r","\u624b\u74b0\u865f\u78bc","getBandName"]],menus:{connect:["\u6210\u529f","\u4e2d\u65b7"],onOff:["\u958b","\u95dc"],wayTD:["\u4e0a","\u4e0b"],wayLR:["\u5de6","\u53f3"],wayFB:["\u524d","\u5f8c"],color3:["\u7d05","\u7da0","\u85cd"],powerV:["4","5","6","7","8","9"],second:["0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"],light9:["1","2","3","4","5","6","7","8","9"],light10:["0",
"1","2","3","4","5","6","7","8","9"],angle:["0","90","180","270"]},url:"http://danco-tek.com/scratch/"};loadJS()})({});